{"name":"Data manipulation with 'tidyr' and 'reshape2'","tagline":"A lesson in R for the SFU study group","body":"## Motivation\r\nBoth `reshape2` and `tidyr` are great R packages used to manipulate your data from the 'wide' to the 'long' format, or vice-versa. The 'long' format is where:\r\n\r\n - each column is a variable\r\n - each row is an observation\r\n\r\nIn the 'long' format, you usually have 1 column for the observed variable and the other columns are ID variables. For the 'wide' format each row is often a site/subject/patient and you have multiple observation variables. These can be either repeated observations over time, or observation of multiple variables (or a mix of both). You may find data input may be simpler or some other applications may prefer the 'wide' format. However, many of `R`'s functions have been designed assuming you have 'long' format data. This tutorial will help you efficiently transform your data regardless of original format.\r\n \r\n###Getting started\r\nFirst install the packages if you haven't already done so:\r\n\r\n    if (!require(\"tidyr\")) install.packages(\"tidyr\")\r\n    if (!require(\"reshape2\")) install.packages(\"reshape2\")\r\n    if (!require(\"plyr\")) install.packages(\"plyr\")\r\n\r\n### Load the packages\r\n\r\n    library(\"tidyr\")\r\n    library(\"reshape2\")\r\n    library(\"plyr\")\r\n\r\n### Loading the data\r\nLoad the data, we're using the inflammation data from the [Software Carpentry novice R lessons](https://github.com/swcarpentry/r-novice-inflammation)\r\n\r\n    data <- read.csv(\"inflammation-01.csv\", header=FALSE)\r\n\r\nEach row in this data represents a patient and columns represent measurements of inflammation over time.\r\n\r\n    dim(data)\r\n\r\nLets put some more informative labels on this dataframe:\r\n\r\n    names(data) <- c(paste0(\"day_\", 1:40))\r\n    head(data)\r\n\r\nLets add patient IDs. Yes the method below is a bit more complicated than it needs to be for now, but the `patientID`'s position will be important later.\r\n\r\n    patientID <- c(1:60)\r\n    data <- cbind(patientID, data)\r\n    head(data)\r\n\r\nNow the dataframe is human-friendly, but what happens if we need to run an analysis with all the inflammation values in 1 column? (e.g. repeated measures ANOVA). Another motivation is to have data that meets the basic tenants of well organized \"tidy\" data where each column is a variable and each row is an observation.\r\n\r\nTo meet these criteria, our dataframe should have 3 columns (variables): `patientID`, `day`, and `inflammation`. We could use some \"brute-force\" coding to re-organize the data, but that's encouraging mistakes. With the `reshape2` or `tidyr` packages, we have the tools to easily re-organize our data.\r\n\r\n## From wide to long with reshape2::melt()\r\nFirst, lets try melt() from the reshape2 package:\r\n\r\n    reshaped_data <- melt(data)\r\n    head(reshaped_data)\r\n    tail(reshaped_data)\r\n\r\nThis is not quite what we needed, `melt()` took all the columns and treated them equally because we didn't tell it that patientID is an important id variable.\r\nLets try that again but this time specify the id variables.\r\n\r\n    reshaped_data <- melt(data, id.vars = \"patientID\")\r\n    head(reshaped_data)\r\n\r\nWhat if we had some other information about the patients that we think may be important?\r\nLet's assume that each patient was given 1 of 3 different drugs. Again, this is a bit more complicated than it needs to be for now, but the `drug`'s position will be important later.\r\n\r\n    drugs <- rep(c(\"A\", \"B\", \"C\"), each = 20)\r\n    data <- as.data.frame(append(data, list(drug = drugs), after = 1))\r\n    head(data)\r\n\r\nWe now need to specify both `patientID` and `drug` as ID variables.\r\n\r\n    reshaped_data <- melt(data, id.vars = c(\"patientID\", \"drug\"))\r\n    head(reshaped_data)\r\n    tail(reshaped_data)\r\n\r\nThe variables named `patientID` and `drug` are descriptive, but `variable` and `value` are not. We can fix that in `melt()`.\r\n\r\n    reshaped_data <- melt(data, id.vars = c(\"patientID\", \"drug\"), variable.name = \"day\", value.name = \"inflammation\")\r\n\r\n> **Challenge problem 1**\r\n> Assuming `data_example <- data`and `data_example` had a variable called `dose` which has the values:\r\n> \r\n> `data_example$dose <- rep(c(\"single\", \"double\"), each = 10,3)`\r\n> \r\n> If we want 'long' format data, should `dose` be an observation or an ID variable?\r\n> \r\n><sub> * answers to challenge problems can be found at the bottom of this page</sub>\r\n\r\n## Fixing variables with reshape2::colsplit()\r\n\r\nYou can also manipulate data that is in 1 variable. In this data, we might want to seperate the numeric `day` value from `day_x`. This would be particularly useful if the time units were not consistent (i.e. some as `day_x` and some as `week_x`)\r\n\r\n    day_splits <- colsplit(reshaped_data$day, \"_\", c(\"unit_time\", \"time\"))\r\n    head(day_splits)\r\n\r\n## From long to wide with reshape2::dcast()\r\nNow if for some reason, you did not keep the original data (e.g. hard-drive failure?) and you need the data with the original formatting back (e.g. if your colleague will only work with it in that format), we can easily re-organize the data back to the original format\r\n\r\n    unreshaped_data <- dcast(reshaped_data, patientID+drug~day, value.var='inflammation')\r\n\r\nA brief note on the syntax here; the value variable that gets broken up is `inflammation` (the column with all the `inflammation` values). The new column names for the `inflammation` values comes from the `day` column (on the right side of the `~`) and the id variables (`patientID+drug`) are on the right side of the `~` seperated by `+`\r\n\r\nLet's double-check that we didn't mess anything up along the way:\r\n\r\n    identical(data,unreshaped_data)\r\n\r\n> **Challenge problem 2**\r\n> Assuming `data_example <- data` and `names(data_example) <- c(paste0(\"day_\", 1:20,\"_var1\"), paste0(\"day_\", 1:20,\"_var2\"))`. If , for some reason, we wanted a format that was intermediate to the long and wide formats. How could you get `data_intermediate` with 5 columns (`patientID,drug,day,var1,var2`). Hint: you may find it easier to use all 3 functions we just learned (`melt(),colsplit(),dcast()`) and you're aiming to get a dataframe with 1200 rows.\r\n> \r\n><sub> * answers to challenge problems can be found at the bottom of this page</sub>\r\n\r\n## From wide to long with tidyr::gather()\r\nThe `tidyr` package does the same kinds of things albeit with different syntax. This is similar to `melt()`, it will reorganize your data in the 'long' format. Note that in this case, the ID variables (`patientID` and `drug` are left out)\r\n\r\n    tidied_data <- gather(data, day, inflammation, day_1:day_40)\r\n    head(tidied_data)\r\n    identical(tidied_data, reshaped_data)\r\n\r\nGather also allows the alternative syntax of using the `-` symbol to identify which variables are not to be gathered (i.e. ID variables)\r\n\r\n    tidied_data <- gather(data, day, inflammation, -patientID, -drug)\r\n    head(tidied_data)\r\n    identical(tidied_data, reshaped_data)\r\n\r\n> **Challenge problem 3**\r\n> Assuming `data_example <- data`. If we wanted to omit `day_35` to `day_40` from the 'long' format data, how could we do that without removing those variables from data_example.\r\n> \r\n> \r\n><sub> * answers to challenge problems can be found at the bottom of this page</sub>\r\n\r\n## Fixing variables with tidyr::separate()\r\nSimilar to `colsplit()`, `separate()` will split a variable into multiple\r\n\r\n    day_splits <- separate(tidied_data, day, c(\"unit_time\",\"time\"), sep=\"_\")\r\n\r\n## From long to wide with tidyr::spread()\r\nSimilar to `dcast()`, spread() will reorganize your data into the 'wide' format.\r\n\r\n    untidied_data <- spread(tidied_data,day, inflammation)\r\n    head(untidied_data)\r\n    \r\n    identical(untidied_data, data)\r\n    identical(untidied_data, unreshaped_data)\r\n\r\n## Side by side comparison\r\n`tidyr` is designed specifically to tidy dataframes while `reshape2` is a bit more for general reshaping\r\n\r\nThey seem to be roughly equally efficient computationally\r\n\r\n    data_big <- rbind.fill(replicate(10000, data, simplify = FALSE))\r\n    \r\n    system.time(melt(data_big, id.vars=c(\"patientID\",\"drug\"), variable.name=\"day\", value.name=\"inflammation\"))\r\n    system.time(gather(data_big, day, inflammation, day_1:day_40))\r\n\r\n`reshape2` allows functions which is useful when id variables are not unique. Here we calculate the mean `inflammation` for each `drug`\r\n\r\n    means_drug <- dcast( reshaped_data, drug ~ day, value.var=\"inflammation\", fun.aggregate = mean)\r\n    head(means_drug)\r\n\r\nYou can also use `dcast`'s sybling `acast()` to get an array instead of a dataframe\r\n\r\n    unreshaped_data_array <- acast(reshaped_data, patientID+drug~day, value.var='inflammation')\r\n\r\n## Example analysis\r\nAbove, I had suggested using a repeated measures ANOVA. Let's try examining the effect of `drug` on our patients with repeated measures over time. \r\n\r\n    aov_output <- aov(inflammation ~ drug*day + Error(patientID/drug), data = tidied_data)\r\n    summary(aov_output)\r\n    \r\nDon't worry so much about the specific formulation of the aov, but rather that we were able to do it with the 'long' format data. We can't use `aov()` on the 'wide' format because the dependent variable `inflammation` is spread out over multiple columns. For more information on repeated measures ANOVA:\r\nhttp://ww2.coastal.edu/kingw/statistics/R-tutorials/repeated.html\r\nOr for general statistics in `R`:\r\n* it would be great to link to the statistics lesson once it up\r\n\r\n## Other great resources:\r\n#### General:\r\nhttp://www.cookbook-r.com/Manipulating_data/Converting_data_between_wide_and_long_format/\r\nhttp://www.rstudio.com/resources/cheatsheets/\r\n#### tidyr:\r\nhttp://cran.r-project.org/web/packages/tidyr/vignettes/tidy-data.html\r\nhttp://blog.rstudio.org/2014/07/22/introducing-tidyr/\r\n\r\n#### reshape2:\r\nhttp://seananderson.ca/2013/10/19/reshape.html\r\n\r\n\r\n> **Answers to challenge problem**\r\n >\r\n - Challenge problem 1:\r\n\t - It would be better to include `dose` as an ID variable since it identifies which type of treatment was received by that patient. You would use: `reshaped_data <- melt(data, id.vars = c(\"patientID\", \"drug\"))` to reorganize the data\r\n - Challenge problem 2:\r\n\t - First, reorganize into the full 'long' format \r\n\t\t - `data_example_long <- melt(data_example, id.vars = c(\"patientID\", \"drug\"), variable.name = \"day_var\", value.name = \"value\")`\r\n\t - Second, split the `day_var` column\r\n\t\t - `data_example_long <- cbind(data_example_long,colsplit(data_example_long$day_var,\"_\", c(\"unit_time\", \"day\", \"var\")))`\r\n\t - Lastly, reorganize into an intermediate format \r\n\t\t - `data_intermediate <- dcast(data_example_long, patientID+drug+day~var, value.var='value')`\t\r\n - Challenge problem 3:\r\n\t - This was a bit of a trick question to make sure you understood that the `-` before the variable names for the gather function are not to omit those variables completely, but rather use those as an ID variable. `tidied_data_example <- gather(data_example[,-37:42], day, inflammation, -patientID, -drug)`","google":"UA-50638009-3","note":"Don't delete this file! It's used internally to help with page regeneration."}